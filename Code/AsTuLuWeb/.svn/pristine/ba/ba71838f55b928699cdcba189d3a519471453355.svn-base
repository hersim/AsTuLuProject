using System;
using System.Collections.Generic;
using System.Data.Entity;
using System.Data.Entity.Validation;
using System.Diagnostics;
using System.Linq;
using System.Data;
using AsTuLuWebProject.Database;
using System.Transactions;

namespace AsTuLuWebProject.Models.Interfaces.DAL
{
    public class BookRepository : IBookRepository
    {
        private readonly AsTuLusEntities Context;  

        private readonly IEditorRepository EditorRepository;

        private readonly ICategoryRepository CategoryRepository;

        private bool Disposed;

        public BookRepository(AsTuLusEntities context)
        {
            Context = context;

            EditorRepository = new EditorRepository(context);
            CategoryRepository = new CategoryRepository(context);

            Disposed = false;
        }

        public List<Book> ListBooks() 
        {
            return Context.Book.ToList();
        }

        public List<Book> ListHighestRatingBooks()
        {
            return Context.Book.OrderBy(_x => _x.Score).ToList();
        }

        public List<Book> ListTwentyLatestBooks(int pageNumber, string firstOption, string secondOption)
        {
            List<Book> listBook = new List<Book>();

            IQueryable<Book> bookQuery = from b in Context.Book
                select b;

            int pageCount = pageNumber - 1;

            switch (firstOption)
            {
                case "New":
                    switch (secondOption)
                    {
                        case "Score":
                            listBook = bookQuery.OrderByDescending(_x => _x.DateAdded).ThenBy(_x => _x.Score).Include("Editor").Include("Reviews").Include("Category").Skip(pageCount * 20).Take(20).ToList();
                            break;
                        case "Newer":
                            listBook = bookQuery.OrderByDescending(_x => _x.DateAdded).Include("Editor").Include("Reviews").Include("Category").Skip(pageCount * 20).Take(20).ToList();
                            break;
                        case "Popular":
                            listBook = bookQuery.OrderByDescending(_x => _x.DateAdded).ThenBy(_x => _x.TimesConsulted).Include("Editor").Include("Reviews").Include("Category").Skip(pageCount * 20).Take(20).ToList();
                            break;
                    }
                    break;
                case "Viral":
                    switch (secondOption)
                    {
                        case "Score":
                            listBook = bookQuery.OrderByDescending(_x => _x.Score).Include("Editor").Include("Reviews").Include("Category").Skip(pageCount * 20).Take(20).ToList();
                            break;
                        case "Newer":
                            listBook = bookQuery.OrderByDescending(_x => _x.Score).ThenBy(_x => _x.DateAdded).Include("Editor").Include("Reviews").Include("Category").Skip(pageCount * 20).Take(20).ToList();
                            break;
                        case "Popular":
                            listBook = bookQuery.OrderByDescending(_x => _x.Score).ThenBy(_x => _x.TimesConsulted).Include("Editor").Include("Reviews").Include("Category").Skip(pageCount * 20).Take(20).ToList();
                            break;
                    }
                    break;
            }

            (this).Dispose();

            return listBook;
        }

        public bool HasDisposed()
        {
            return Disposed;
        }

        public List<Book> ListRandomBooks(int pageNumber)
        {
            Random random = new Random();

            var Book = from b in Context.Book
                        select b;

            int totalCount = Book.Count();

            List<Book> listToReturn = new List<Book>();

            while (listToReturn.Count < 20)
            {
                int randomNumber = random.Next(1, totalCount);

                if (listToReturn.All(_item => _item.BookID != randomNumber))
                {
                    Book bookToAdd = Context.Book.Find(randomNumber);

                    listToReturn.Add(bookToAdd);
                }
            }

            return listToReturn;
        }

        public Book GetBookById(int bookId, bool hasDisposed)
        {
            Book bookToReturn = Context.Book.Include("Editor").Include("Reviews").Include("Reviews.Comments").Include("Category").FirstOrDefault(_item => _item.BookID == bookId);

            if (bookToReturn == null)
            {
                return null;
            }

            if (!hasDisposed)
            {
                bookToReturn.TimesConsulted++;

                bookToReturn.Editor.TimeEditorConsulted++;

                bookToReturn.Category.TimesCategoryConsulted++;
            }
            
            Save();

            return bookToReturn;
        }

        public BookByUser GetRelationshipForBook(UserAccount userAccount, Book bookToShow)
        {
            IQueryable<BookByUser> bookRelationShip = from br in Context.BookByUser
                where br.BookID == bookToShow.BookID
                where br.UserAccountID == userAccount.AccountID
                select br;

            BookByUser bookRel;

            if (!bookRelationShip.Any())
            {
                bookRel = new BookByUser
                {
                    BookID = bookToShow.BookID,
                    UserAccountID = userAccount.AccountID,
                    DateCreated = DateTime.Now,
                    DateModified = DateTime.Now,
                };

                Context.BookByUser.Add(bookRel);
            }
            else
            {
                bookRel = bookRelationShip.First();
            }

            Dispose(true);

            return bookRel;
        }

        public bool CheckIfBookPresent(BookModel bookToCheck)
        {
            IQueryable<Book> Book = from bo in Context.Book
                        where bo.BookName == bookToCheck.BookName
                        select bo;

            if (!Book.Any())
            {
                return false;
            }

            if (bookToCheck.Year == null || bookToCheck.PageNumber == null)
            {
                return Enumerable.Any(Book, book => book.Editor.EditorName == bookToCheck.EditorName && 
                    book.PrimaryAuthor == bookToCheck.Author1 && 
                    book.SecondAuthor == bookToCheck.Author2 && 
                    book.ThirdAuthor == bookToCheck.Author3);
            }

            return Enumerable.Any(Book
                                      .Where(book => book.Editor.EditorName == bookToCheck.EditorName)
                                      .Where(book => book.PublishedYear != null && book.PageNumber != null), 
                                  book => book.PublishedYear == int.Parse(bookToCheck.Year) && 
                                          book.PageNumber == int.Parse(bookToCheck.PageNumber));
        }

        public bool CheckIfBookPresent(Book bookToCheck)
        {
            var Book = from bo in Context.Book
                        where bo.BookName == bookToCheck.BookName
                        where bo.EditorID == bookToCheck.EditorID
                        where bo.PrimaryAuthor == bookToCheck.PrimaryAuthor
                        where bo.SecondAuthor == bookToCheck.SecondAuthor
                        where bo.ThirdAuthor == bookToCheck.ThirdAuthor
                        where bo.BookISBN == bookToCheck.BookISBN
                        where bo.PublishedYear == bookToCheck.PublishedYear
                        where bo.PageNumber == bookToCheck.PageNumber
                        select bo;

            return Book.Any();
        }

        public void AddListBook(List<BookModel> listBook)
        {
            using (TransactionScope scope = new TransactionScope())
            {
                if (Context.Database.Connection.State == ConnectionState.Closed)
                {
                    Context.Database.Connection.Open();
                }

                foreach (var book in listBook)
                {
                    AddBook(book);
                }

                scope.Complete();
            }
        }

        public void AddBook(Book book)
        {
            Context.Book.Add(book);

            Context.Entry(book).State = EntityState.Added;
        }

        public void AddBook(BookModel bookModel) 
        {
            if (Context.Database.Connection.State == ConnectionState.Closed)
            {
                Context.Database.Connection.Open();
            }

            Book bookToAdd = new Book
            {
                BookISBN = bookModel.ISBN,
                BookName = bookModel.BookName,
                PrimaryAuthor = bookModel.Author1,
                SecondAuthor = bookModel.Author2,
                ThirdAuthor = bookModel.Author3,
                BookCollection = bookModel.CollectionTag,
                BookSerie = bookModel.SerieTag
            };

            int _number;

            if (int.TryParse(bookModel.Number, out _number))
            {
                bookToAdd.BookNumber = _number;
            }

            Editor editor = EditorRepository.GetEditorByName(bookModel.EditorName);

            if (editor == null)
            {
                editor = new Editor
                {
                    EditorName = bookModel.EditorName,
                    DateCreated = DateTime.Now,
                    EditorScore = 0,
                };

                EditorRepository.AddEditor(editor);

                EditorRepository.Save();

                editor = EditorRepository.GetEditorByName(bookModel.EditorName);
            }

            bookToAdd.EditorID = editor.EditorID;

            switch (bookModel.Language)
            {
                case "Français":
                    bookToAdd.BookLanguage = 1;
                    break;
                case "Anglais":
                    bookToAdd.BookLanguage = 2;
                    break;
                default:
                    bookToAdd.BookLanguage = 0;
                    break;
            }

            Category category = CategoryRepository.GetCategoryByNameAndSubtype(bookModel.CategoryName, bookModel.SubCategoryName);

            if (category == null)
            {
                category = new Category
                    {
                        CategoryName = bookModel.CategoryName,
                        TimesCategoryConsulted = 0
                    };

                if (!String.IsNullOrWhiteSpace(bookModel.SubCategoryName))
                {
                    category.SubCategory.Add(new SubCategory
                    {
                        SubCategoryName = bookModel.SubCategoryName,
                        TimesSubCatConsulted = 0
                    });    
                }

                CategoryRepository.AddCategory(category);

                CategoryRepository.Save();

                category = CategoryRepository.GetCategoryByNameAndSubtype(bookModel.CategoryName, bookModel.SubCategoryName);
            }

            bookToAdd.CategoryID = category.CategoryID;

            if (bookModel.PageNumber != null)
            {
                bookToAdd.PageNumber = int.Parse(bookModel.PageNumber);    
            }

            bookToAdd.PublishedYear = int.Parse(bookModel.Year);

            bookToAdd.DateAdded = DateTime.Now;

            Context.Book.Add(bookToAdd);

            Context.Entry(bookToAdd).State = EntityState.Added;

            try
            {

                Context.SaveChanges();
            }
            catch (DbEntityValidationException e)
            {
                foreach (var eve in e.EntityValidationErrors)
                {
                    Console.WriteLine("Entity of type \"{0}\" in state \"{1}\" has the following validation errors:",
                        eve.Entry.Entity.GetType().Name, eve.Entry.State);
                    foreach (var ve in eve.ValidationErrors)
                    {
                        Console.WriteLine("- Property: \"{0}\", Error: \"{1}\"",
                            ve.PropertyName, ve.ErrorMessage);
                    }
                }
                throw;
            }
            
        }

        public void DeleteBook(int _bookID) 
        {
            Book book = Context.Book.Find(_bookID);

            Context.Book.Remove(book);

            Context.Entry(book).State = EntityState.Deleted;
        }

        public void UpdateBook(Book updatedBook)
        {
            Context.Entry(updatedBook).State = EntityState.Modified;
        }

        public void Save() 
        {
            try
            {
                Context.SaveChanges();
            }
            catch (DbEntityValidationException dbEx)
            {
                foreach (var dbValidationError in dbEx.EntityValidationErrors.
                    SelectMany(_dbEntityValidationResult => _dbEntityValidationResult.ValidationErrors))
                {
                    Trace.TraceInformation("Property: {0} Error: {1}", dbValidationError.PropertyName, dbValidationError.ErrorMessage);
                }
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
            
        }

        protected virtual void Dispose(bool disposing)
        {
            if (!this.Disposed)
            {
                if (disposing)
                {
                    Context.Dispose();
                }
            }
            
            this.Disposed = true;
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }
    }
}